name: Telegram Project Digest

on:
  schedule:
    # –ö–∞–∂–¥—ã–µ 3 —á–∞—Å–∞ (9:00, 12:00, 15:00, 18:00, 21:00 –ø–æ –ú–æ—Å–∫–≤–µ = 6:00, 9:00, 12:00, 15:00, 18:00 UTC)
    - cron: '0 6,9,12,15,18 * * *'
  workflow_dispatch: # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

jobs:
  digest:
    runs-on: ubuntu-latest
    steps:
      - name: Get project items and send digest
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # –ü–æ–ª—É—á–∞–µ–º –∑–∞–¥–∞—á–∏ –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞
          ITEMS=$(gh project item-list 1 --owner susaninz --format json 2>/dev/null || echo '{"items":[]}')
          
          # –ü–∞—Ä—Å–∏–º –∑–∞–¥–∞—á–∏ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
          BACKLOG=$(echo "$ITEMS" | jq -r '[.items[] | select(.status == "Backlog")] | length')
          READY=$(echo "$ITEMS" | jq -r '[.items[] | select(.status == "Ready")] | length')
          IN_PROGRESS=$(echo "$ITEMS" | jq -r '[.items[] | select(.status == "In progress")] | length')
          IN_REVIEW=$(echo "$ITEMS" | jq -r '[.items[] | select(.status == "In review")] | length')
          DONE=$(echo "$ITEMS" | jq -r '[.items[] | select(.status == "Done")] | length')
          
          # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á –≤ —Ä–∞–±–æ—Ç–µ
          IN_PROGRESS_LIST=$(echo "$ITEMS" | jq -r '.items[] | select(.status == "In progress") | "‚Ä¢ " + .title' | head -5)
          
          # –ü–æ–ª—É—á–∞–µ–º –∑–∞–¥–∞—á–∏ –¥–ª—è –†–∞–∫–∏—Ç–∏–Ω–∞
          RAKITIN_TASKS=$(echo "$ITEMS" | jq -r '.items[] | select(.title | contains("@rakitin")) | select(.status != "Done") | "‚Ä¢ " + .title' | sed 's/\[@rakitin\] //' | head -10)
          
          # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
          MESSAGE="üìä <b>–°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞ Nomusicians</b>%0A%0A"
          MESSAGE+="üìã Backlog: $BACKLOG%0A"
          MESSAGE+="üéØ Ready: $READY%0A"
          MESSAGE+="üîÑ In Progress: $IN_PROGRESS%0A"
          MESSAGE+="üëÄ In Review: $IN_REVIEW%0A"
          MESSAGE+="‚úÖ Done: $DONE%0A"
          
          if [ -n "$IN_PROGRESS_LIST" ]; then
            MESSAGE+="%0A<b>–í —Ä–∞–±–æ—Ç–µ:</b>%0A$IN_PROGRESS_LIST%0A"
          fi
          
          if [ -n "$RAKITIN_TASKS" ]; then
            MESSAGE+="%0A<b>–ó–∞–¥–∞—á–∏ –†–∞–∫–∏—Ç–∏–Ω–∞:</b>%0A$RAKITIN_TASKS%0A"
          fi
          
          MESSAGE+="%0Aüîó <a href='https://github.com/users/susaninz/projects/1'>–û—Ç–∫—Ä—ã—Ç—å –¥–æ—Å–∫—É</a>"
          
          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –¢–µ–ª–µ–≥—Ä–∞–º
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode="HTML" \
            -d text="$MESSAGE"

