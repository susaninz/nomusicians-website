name: Telegram Project Digest

on:
  schedule:
    # –†–∞–∑ –≤ –¥–µ–Ω—å –≤ 10:00 –ø–æ –ú–æ—Å–∫–≤–µ (7:00 UTC)
    - cron: '0 7 * * *'
  workflow_dispatch: # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

jobs:
  digest:
    runs-on: ubuntu-latest
    steps:
      - name: Get project items and send digest
        env:
          GH_TOKEN: ${{ secrets.GH_PROJECT_TOKEN }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # –ü–æ–ª—É—á–∞–µ–º –∑–∞–¥–∞—á–∏ –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª
          gh project item-list 1 --owner susaninz --format json > /tmp/items.json 2>/dev/null || echo '{"items":[]}' > /tmp/items.json
          
          # –ü–∞—Ä—Å–∏–º –∑–∞–¥–∞—á–∏ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
          BACKLOG=$(jq -r '[.items[] | select(.status == "Backlog")] | length' /tmp/items.json 2>/dev/null || echo "0")
          READY=$(jq -r '[.items[] | select(.status == "Ready")] | length' /tmp/items.json 2>/dev/null || echo "0")
          IN_PROGRESS=$(jq -r '[.items[] | select(.status == "In progress")] | length' /tmp/items.json 2>/dev/null || echo "0")
          IN_REVIEW=$(jq -r '[.items[] | select(.status == "In review")] | length' /tmp/items.json 2>/dev/null || echo "0")
          DONE=$(jq -r '[.items[] | select(.status == "Done")] | length' /tmp/items.json 2>/dev/null || echo "0")
          
          # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á –≤ —Ä–∞–±–æ—Ç–µ
          IN_PROGRESS_LIST=$(jq -r '.items[] | select(.status == "In progress") | "‚Ä¢ " + .title' /tmp/items.json 2>/dev/null | head -5)
          
          # –ü–æ–ª—É—á–∞–µ–º –∑–∞–¥–∞—á–∏ –¥–ª—è –†–∞–∫–∏—Ç–∏–Ω–∞
          RAKITIN_TASKS=$(jq -r '.items[] | select(.title | contains("@rakitin")) | select(.status != "Done") | "‚Ä¢ " + .title' /tmp/items.json 2>/dev/null | sed 's/\[@rakitin\] //' | head -10)
          
          # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
          MESSAGE="üìä <b>–°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞ Nomusicians</b>%0A%0A"
          MESSAGE+="üìã Backlog: $BACKLOG%0A"
          MESSAGE+="üéØ Ready: $READY%0A"
          MESSAGE+="üîÑ In Progress: $IN_PROGRESS%0A"
          MESSAGE+="üëÄ In Review: $IN_REVIEW%0A"
          MESSAGE+="‚úÖ Done: $DONE%0A"
          
          if [ -n "$IN_PROGRESS_LIST" ]; then
            MESSAGE+="%0A<b>–í —Ä–∞–±–æ—Ç–µ:</b>%0A$IN_PROGRESS_LIST%0A"
          fi
          
          if [ -n "$RAKITIN_TASKS" ]; then
            MESSAGE+="%0A<b>–ó–∞–¥–∞—á–∏ –†–∞–∫–∏—Ç–∏–Ω–∞:</b>%0A$RAKITIN_TASKS%0A"
          fi
          
          MESSAGE+="%0Aüîó <a href='https://github.com/users/susaninz/projects/1'>–û—Ç–∫—Ä—ã—Ç—å –¥–æ—Å–∫—É</a>"
          
          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –¢–µ–ª–µ–≥—Ä–∞–º
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode="HTML" \
            -d disable_web_page_preview="true" \
            -d text="$MESSAGE"
          
          # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
          rm -f /tmp/items.json
