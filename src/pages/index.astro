---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Hero from '../components/Hero.astro';
import Footer from '../components/Footer.astro';
import { getEventsForHome, getFeaturedVideoAlbums, urlFor, type SanityEvent } from '../lib/sanity';
import { t } from '../i18n/translations';

const lang = 'ru';

// Получаем события для главной из Sanity
const sanityEvents = await getEventsForHome();

// Короткие названия месяцев (не более 3 символов)
// Всегда выводим год — для единообразия, т.к. лента может быть длинной
function formatDateShort(dateStr: string): string {
  const date = new Date(dateStr);
  const months = ['янв', 'фев', 'мар', 'апр', 'май', 'июн', 'июл', 'авг', 'сен', 'окт', 'ноя', 'дек'];
  const day = date.getDate();
  const month = months[date.getMonth()];
  const year = date.getFullYear();
  
  return `${day} ${month} ${year}`;
}

// Преобразуем события в формат для отображения
const events = sanityEvents.map((e: SanityEvent) => {
  const city = e.city?.[lang] || e.city?.ru || '';
  const venue = e.venue?.[lang] || e.venue?.ru || '';
  const description = e.description?.[lang] || e.description?.ru || '';
  
  // Для концертов формируем место (Площадка, Город)
  const location = (e.eventType === 'concert' && (venue || city)) 
    ? [venue, city].filter(Boolean).join(', ') 
    : '';
  
  return {
    type: e.eventType,
    title: e.title?.[lang] || e.title?.ru || '',
    location,
    description,
    date: formatDateShort(e.date),
    time: e.time || null,
    buttonText: e.buttonText?.[lang] || e.buttonText?.ru || 'Подробнее',
    buttonUrl: e.url || '#',
    isFuture: e.isFuture,
  };
});

// Получаем первое видео из избранного видеоальбома
const featuredVideoAlbums = await getFeaturedVideoAlbums();
const firstFeaturedVideo = featuredVideoAlbums[0]?.videos?.[0];

// Функция для получения YouTube thumbnail
function getYoutubeThumbnail(url: string): string {
  const match = url?.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&]+)/);
  if (match && match[1]) {
    return `https://img.youtube.com/vi/${match[1]}/maxresdefault.jpg`;
  }
  return '/og-image.png';
}

// Функция для YouTube watch URL
function getYouTubeWatchUrl(url: string): string {
  if (!url) return '#';
  const match = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]+)/);
  if (match) return `https://www.youtube.com/watch?v=${match[1]}`;
  return url;
}

const featuredVideo = firstFeaturedVideo ? {
  title: firstFeaturedVideo.title?.[lang] || firstFeaturedVideo.title?.ru || '',
  url: getYouTubeWatchUrl(firstFeaturedVideo.url),
  thumbnail: firstFeaturedVideo.thumbnail 
    ? urlFor(firstFeaturedVideo.thumbnail).width(800).url() 
    : getYoutubeThumbnail(firstFeaturedVideo.url),
} : null;
---

<Layout title="Nomusicians — Электроника и неоклассика" lang="ru">
  <Header currentLang={lang} />
  <main>
    <Hero lang={lang} />
    
    <!-- Блок "Актуальное" -->
    {events.length > 0 && (
      <section class="bg-surface py-16 px-6">
        <div class="max-w-4xl mx-auto">
          <p class="text-muted text-sm tracking-[0.2em] uppercase mb-8 text-center">
            {t(lang, 'events.featured')}
          </p>
          
          <!-- Карточки событий (вёрстка v7-full) -->
          <div class="space-y-4">
            {events.map((event) => (
              <a 
                href={event.buttonUrl}
                class={`group flex items-start justify-between py-4 px-6 border ${event.isFuture ? 'border-white/20' : 'border-white/10'} hover:border-white/30 hover:bg-white/5 transition-all no-underline ${!event.isFuture ? 'opacity-60 hover:opacity-100' : ''}`}
              >
                <!-- Текст -->
                <div class="text-left flex-1 min-w-0 pr-8">
                  <p class="text-white font-light flex items-center gap-2">
                    {event.isFuture && (
                      <svg class="w-4 h-4 text-white flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
                      </svg>
                    )}
                    {event.title}
                    {event.location && <span class="text-white/50"> | {event.location}</span>}
                  </p>
                  {event.description && <p class="text-muted text-sm">{event.description}</p>}
                </div>
                
                <!-- Дата + Кнопка (вертикально) -->
                <div class="flex flex-col items-end gap-1 flex-shrink-0 min-w-[100px]">
                  <div class="text-right">
                    <p class="text-white text-sm">{event.date}</p>
                    {event.time && <p class="text-muted text-xs">{event.time}</p>}
                  </div>
                  <span class="text-white/60 text-xs tracking-wider uppercase whitespace-nowrap group-hover:text-white transition-colors">
                    {event.buttonText} →
                  </span>
                </div>
              </a>
            ))}
          </div>
          
          <!-- Все события -->
          <div class="mt-10 text-center">
            <a href="/events" class="text-muted hover:text-white transition-colors text-sm inline-flex items-center gap-2">
              {t(lang, 'events.allEvents')}
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
              </svg>
            </a>
          </div>
        </div>
      </section>
    )}

    <!-- Одно избранное видео -->
    {featuredVideo && (
      <section id="watch" class="py-20 px-6">
        <div class="max-w-4xl mx-auto">
          <a 
            href={featuredVideo.url} 
            target="_blank" 
            rel="noopener noreferrer"
            class="block relative aspect-video group overflow-hidden no-underline"
          >
            <img 
              src={featuredVideo.thumbnail}
              alt={featuredVideo.title}
              class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-700"
            />
            <div class="absolute inset-0 bg-black/40 group-hover:bg-black/20 transition-all duration-500 flex items-center justify-center">
              <div class="w-20 h-20 rounded-full border-2 border-white/80 flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                <svg class="w-8 h-8 text-white ml-1" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M8 5v14l11-7z"/>
                </svg>
              </div>
            </div>
            <div class="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-black/80 to-transparent">
              <h3 class="text-white text-xl font-light">{featuredVideo.title}</h3>
            </div>
          </a>
        </div>
      </section>
    )}
    
    <Footer />
  </main>
</Layout>

<style>
  a {
    text-decoration: none !important;
  }
</style>
