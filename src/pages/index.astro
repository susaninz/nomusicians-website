---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Hero from '../components/Hero.astro';
import Concert from '../components/Concert.astro';
import Footer from '../components/Footer.astro';
import { getActiveTour, getVideoForHome, urlFor } from '../lib/sanity';

const lang = 'ru';

// Получаем активный тур из Sanity
const sanityTour = await getActiveTour();

// Преобразуем в формат для компонента
const tour = sanityTour ? {
  title: sanityTour.title,
  description: sanityTour.description?.[lang] || sanityTour.description?.ru || '',
  events: sanityTour.events?.map(e => ({
    date: e.date?.[lang] || e.date?.ru || '',
    time: e.time || '',
    city: e.city?.[lang] || e.city?.ru || '',
    venue: e.venue || '',
    ticketUrl: e.ticketUrl || '#',
  })) || [],
} : null;

// Получаем видео для главной (с галочкой showOnHome)
const homeVideo = await getVideoForHome();

// Функция для получения YouTube thumbnail
function getYoutubeThumbnail(url: string): string {
  const match = url?.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&]+)/);
  if (match && match[1]) {
    return `https://img.youtube.com/vi/${match[1]}/maxresdefault.jpg`;
  }
  return '/og-image.png';
}

const featuredVideo = homeVideo ? {
  title: homeVideo.title,
  url: homeVideo.youtubeUrl,
  thumbnail: homeVideo.thumbnail 
    ? urlFor(homeVideo.thumbnail).width(800).url() 
    : getYoutubeThumbnail(homeVideo.youtubeUrl),
} : null;
---

<Layout title="Nomusicians — Электроника и неоклассика" lang="ru">
  <Header currentLang={lang} />
  <main>
    <Hero lang={lang} />
    
    {tour && tour.events.length > 0 && (
      <Concert lang={lang} tour={tour} />
    )}
    
    <!-- Одно избранное видео -->
    {featuredVideo && (
      <section id="watch" class="py-20 px-6">
        <div class="max-w-4xl mx-auto">
          <a 
            href={featuredVideo.url} 
            target="_blank" 
            rel="noopener noreferrer"
            class="block relative aspect-video group overflow-hidden no-underline"
          >
            <img 
              src={featuredVideo.thumbnail}
              alt={featuredVideo.title}
              class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-700"
            />
            <div class="absolute inset-0 bg-black/40 group-hover:bg-black/20 transition-all duration-500 flex items-center justify-center">
              <div class="w-20 h-20 rounded-full border-2 border-white/80 flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                <svg class="w-8 h-8 text-white ml-1" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M8 5v14l11-7z"/>
                </svg>
              </div>
            </div>
            <div class="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-black/80 to-transparent">
              <h3 class="text-white text-xl font-light">{featuredVideo.title}</h3>
            </div>
          </a>
        </div>
      </section>
    )}
    
    <Footer />
  </main>
</Layout>
