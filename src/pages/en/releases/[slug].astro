---
import Layout from '../../../layouts/Layout.astro';
import Header from '../../../components/Header.astro';
import { getReleases, urlFor } from '../../../lib/sanity';

// Для статической генерации
export async function getStaticPaths() {
  const releases = await getReleases();
  return releases.map(release => ({
    params: { slug: release.slug?.current || release.title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '') },
    props: { release },
  }));
}

const { release } = Astro.props;
const lang = 'en';

// Основная обложка
const coverUrl = release.cover ? urlFor(release.cover).width(600).url() : '/og-image.png';

// Дополнительные обложки (Side B, фото винила)
const additionalCoversFromSanity = release.additionalCovers || [];
const hasAdditionalCovers = additionalCoversFromSanity.length > 0;

// Формируем массив обложек
const covers = hasAdditionalCovers 
  ? [
      { url: coverUrl, label: 'Side A' },
      ...additionalCoversFromSanity.map((img: any, i: number) => ({
        url: urlFor(img).width(600).url(),
        label: `Side ${String.fromCharCode(66 + i)}`, // B, C, D...
      }))
    ]
  : [{ url: coverUrl, label: '' }];
const hasMultipleCovers = covers.length > 1;

// Описание из Sanity (EN)
const description = release.descriptionEn || release.description || '';

// Дата релиза (форматирование)
const releaseDate = release.releaseDate 
  ? new Date(release.releaseDate).toLocaleDateString('en-US', { day: 'numeric', month: 'long', year: 'numeric' })
  : null;

// Лейбл
const label = release.label || null;

// Треклист из Sanity
const tracklist = release.tracklist || [];

// Credits из Sanity
const credits = release.credits || [];

// Ссылки на стриминги из Sanity
const streamingLinks = [
  { name: 'SoundCloud', url: release.soundcloudUrl, icon: 'soundcloud', color: '#ff5500' },
  { name: 'Yandex', url: release.yandexMusicUrl, icon: 'yandex', color: '#ffcc00' },
  { name: 'Spotify', url: release.spotifyUrl, icon: 'spotify', color: '#1ed760' },
  { name: 'Apple', url: release.appleMusicUrl, icon: 'apple', color: '#fc3c44' },
  { name: 'YouTube', url: release.youtubeMusicUrl, icon: 'youtube', color: '#ff0000' },
  { name: 'Deezer', url: release.deezerUrl, icon: 'deezer', color: '#feaa2d' },
  { name: 'Tidal', url: release.tidalUrl, icon: 'tidal', color: '#00ffff' },
].filter(link => link.url);
---

<Layout title={`${release.title} — Nomusicians`} lang={lang}>
  <Header currentLang={lang} />
  
  <main class="pt-24 pb-16">
    
    <!-- Hero Section -->
    <section class="px-6 mb-16">
      <div class="max-w-5xl mx-auto">
        
        <!-- Back -->
        <a 
          href="/en/releases" 
          class="inline-flex items-center gap-2 text-sm text-white/60 hover:text-white mb-8 transition-colors no-underline"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16l-4-4m0 0l4-4m-4 4h18"></path>
          </svg>
          All Releases
        </a>
        
        <!-- Hero Grid -->
        <div class="flex flex-col md:flex-row gap-8 md:gap-12 items-start">
          
          <!-- Covers -->
          <div class:list={[
            "flex-shrink-0",
            hasMultipleCovers ? "w-full md:w-auto" : "w-full md:w-80"
          ]}>
            {hasMultipleCovers ? (
              <div class="flex gap-4 md:gap-6">
                {covers.map((cover, i) => (
                  <div class="flex flex-col items-center gap-2">
                    <div class="w-40 md:w-56 aspect-square overflow-hidden bg-surface shadow-2xl">
                      <img 
                        src={cover.url} 
                        alt={`${release.title} - ${cover.label}`}
                        class="w-full h-full object-cover"
                        onerror="this.src='/og-image.png'"
                      />
                    </div>
                    {cover.label && (
                      <span class="text-xs text-white/40 uppercase tracking-wider">{cover.label}</span>
                    )}
                  </div>
                ))}
              </div>
            ) : (
              <div class="w-full md:w-80 aspect-square overflow-hidden bg-surface shadow-2xl">
                <img 
                  src={coverUrl} 
                  alt={release.title}
                  class="w-full h-full object-cover"
                />
              </div>
            )}
          </div>
          
          <!-- Main info -->
          <div class="flex-1 space-y-6">
            <div>
              <div class="flex items-center gap-3 mb-3">
                <span class="text-xs text-white/50 bg-white/5 px-3 py-1 rounded-full uppercase tracking-wider">
                  {release.category === 'live' ? 'Live' : release.category === 'studio' ? 'Studio' : 'Collab'}
                </span>
                <span class="text-muted text-sm">{release.year}</span>
              </div>
              <h1 class="text-4xl md:text-5xl font-light tracking-wide text-white mb-3" style="font-family: var(--font-logo);">
                {release.title}
              </h1>
              {release.artist && (
                <p class="text-xl text-muted">{release.artist}</p>
              )}
              
              <div class="flex flex-wrap gap-x-6 gap-y-1 mt-4 text-sm text-white/40">
                {releaseDate && (
                  <span>Released: {releaseDate}</span>
                )}
                {label && (
                  <span>Label: {label}</span>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Listen -->
    <section class="px-6 mt-16 mb-20">
      <div class="max-w-5xl mx-auto">
        <h2 class="text-xs text-muted uppercase tracking-wider mb-4">Listen</h2>
        <div class="flex flex-wrap gap-3">
          {streamingLinks.map(link => (
            <a 
              href={link.url}
              target="_blank"
              rel="noopener noreferrer"
              class={`streaming-b flex items-center gap-3 px-4 py-2.5 border border-white/10 text-white/70 no-underline transition-all duration-300`}
              data-platform={link.icon}
            >
              {link.icon === 'soundcloud' && (
                <svg class="w-5 h-5 icon-muted transition-colors duration-300" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M1.175 12.225c-.051 0-.094.046-.101.1l-.233 2.154.233 2.105c.007.058.05.098.101.098.05 0 .09-.04.099-.098l.255-2.105-.27-2.154c-.009-.06-.052-.1-.084-.1zm-.899 1.18c-.05 0-.091.039-.099.092l-.164 1.08.164 1.056c.008.05.049.09.099.09.05 0 .09-.038.098-.09l.186-1.056-.186-1.08c-.008-.05-.048-.092-.098-.092zm1.799-.6c-.057 0-.101.048-.109.104l-.21 1.77.21 1.725c.008.058.052.104.109.104.054 0 .1-.048.107-.104l.233-1.725-.233-1.77c-.007-.056-.053-.104-.107-.104zm.9-.454c-.063 0-.11.051-.117.109l-.186 2.225.186 2.154c.007.063.054.11.117.11.063 0 .11-.047.117-.11l.209-2.154-.209-2.225c-.007-.058-.054-.109-.117-.109zm5.394-3.15c-.09 0-.164.073-.172.163l-.163 5.165.163 2.107c.008.09.082.164.172.164.089 0 .163-.074.17-.164l.186-2.107-.186-5.165c-.007-.09-.081-.163-.17-.163zm-3.593 1.674c-.072 0-.127.057-.134.127l-.186 3.651.186 2.123c.007.071.062.127.134.127.07 0 .124-.056.131-.127l.209-2.123-.209-3.651c-.007-.07-.061-.127-.131-.127zm.9-.273c-.08 0-.14.062-.148.14l-.163 3.784.163 2.108c.008.08.068.14.148.14.078 0 .14-.06.147-.14l.186-2.108-.186-3.784c-.007-.078-.069-.14-.147-.14zm.899-.137c-.085 0-.149.066-.156.15l-.14 3.784.14 2.106c.007.086.071.15.156.15.085 0 .149-.064.156-.15l.163-2.106-.163-3.784c-.007-.084-.071-.15-.156-.15zm.901-.093c-.093 0-.163.072-.17.163l-.117 3.784.117 2.091c.007.093.077.163.17.163.092 0 .162-.07.17-.163l.131-2.091-.131-3.784c-.008-.091-.078-.163-.17-.163zm4.292 1.406c-.195 0-.379.033-.553.091-.117-1.332-1.241-2.377-2.609-2.377-.341 0-.667.069-.967.186-.115.047-.145.093-.145.186v4.87c0 .099.077.18.172.186h4.102c.963 0 1.746-.787 1.746-1.758-.001-.97-.784-1.384-1.746-1.384z"/>
                </svg>
              )}
              {link.icon === 'yandex' && (
                <svg class="w-5 h-5 icon-muted transition-colors duration-300" viewBox="0 0 24 24" fill="none">
                  <circle cx="12" cy="12" r="11" stroke="currentColor" stroke-width="2"/>
                  <text x="12" y="16" text-anchor="middle" fill="currentColor" font-size="12" font-weight="bold" font-family="Arial">Я</text>
                </svg>
              )}
              {link.icon === 'spotify' && (
                <svg class="w-5 h-5 icon-muted transition-colors duration-300" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/>
                </svg>
              )}
              {link.icon === 'apple' && (
                <svg class="w-5 h-5 icon-muted transition-colors duration-300" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M23.994 6.124a9.23 9.23 0 00-.24-2.19c-.317-1.31-1.062-2.31-2.18-3.043a5.022 5.022 0 00-1.877-.726 10.496 10.496 0 00-1.564-.15c-.04-.003-.083-.01-.124-.013H5.986c-.152.01-.303.017-.455.026-.747.043-1.49.123-2.193.4-1.336.53-2.3 1.452-2.865 2.78-.192.448-.292.925-.363 1.408-.056.392-.088.785-.1 1.18 0 .032-.007.062-.01.093v12.223c.01.14.017.283.027.424.05.815.154 1.624.497 2.373.65 1.42 1.738 2.353 3.234 2.802.42.127.856.187 1.293.228.555.053 1.11.06 1.667.06h11.03a12.5 12.5 0 001.57-.1c.822-.107 1.596-.35 2.296-.81a5.046 5.046 0 001.88-2.207c.186-.42.293-.87.37-1.324.113-.675.138-1.358.137-2.04-.002-3.8 0-7.595-.003-11.393zm-6.423 3.99v5.712c0 .417-.058.827-.244 1.206-.29.59-.76.962-1.388 1.14-.35.1-.706.157-1.07.173-.95.042-1.873-.134-2.66-.728-.587-.44-.96-1.022-1.057-1.76-.07-.53-.046-1.063.148-1.565.36-.94 1.09-1.51 2.025-1.82.48-.16.97-.24 1.47-.297.32-.037.64-.065.96-.094.37-.034.72-.082 1.03-.26.32-.18.48-.45.49-.83.01-.095.008-.19.008-.285V6.64c0-.092-.003-.186-.018-.275-.057-.344-.283-.503-.623-.44-.28.053-.558.12-.837.18-1.197.258-2.393.52-3.59.778l-3.514.76c-.028.007-.057.013-.085.022-.18.05-.302.16-.352.348-.03.11-.043.223-.043.337-.002 2.777-.002 5.555-.004 8.332v.39c-.007.458-.073.91-.286 1.328-.298.584-.77.96-1.4 1.135-.375.105-.758.163-1.143.18-.867.04-1.71-.09-2.458-.596-.63-.428-1.01-.998-1.125-1.75-.084-.54-.062-1.078.134-1.595.35-.923 1.06-1.5 1.975-1.81.5-.17 1.015-.26 1.538-.32.26-.03.52-.053.78-.08.375-.04.735-.1 1.06-.28.31-.17.47-.43.49-.79.01-.1.007-.2.007-.3v-7.96c0-.145.01-.29.034-.432.067-.39.31-.645.692-.75.156-.043.316-.072.476-.1l2.274-.492c1.376-.298 2.754-.594 4.13-.893l1.953-.422c.193-.042.388-.078.584-.105.28-.04.47.1.56.36.04.12.056.25.056.38v6.403z"/>
                </svg>
              )}
              {link.icon === 'youtube' && (
                <svg class="w-5 h-5 icon-muted transition-colors duration-300" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                </svg>
              )}
              {link.icon === 'deezer' && (
                <svg class="w-5 h-5 icon-muted transition-colors duration-300" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M18.81 4.16v3.03H24V4.16h-5.19zM6.27 8.38v3.027h5.189V8.38h-5.19zm12.54 0v3.027H24V8.38h-5.19zM6.27 12.592v3.027h5.189v-3.027h-5.19zm6.27 0v3.027h5.19v-3.027h-5.19zm6.27 0v3.027H24v-3.027h-5.19zM0 16.81v3.029h5.19v-3.03H0zm6.27 0v3.029h5.189v-3.03h-5.19zm6.27 0v3.029h5.19v-3.03h-5.19zm6.27 0v3.029H24v-3.03h-5.19z"/>
                </svg>
              )}
              {link.icon === 'tidal' && (
                <svg class="w-5 h-5 icon-muted transition-colors duration-300" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12.012 3.992L8.008 7.996 4.004 3.992 0 7.996 4.004 12l4.004-4.004L12.012 12l-4.004 4.004 4.004 4.004 4.004-4.004L12.012 12l4.004-4.004-4.004-4.004zm7.992 0l-4.004 4.004 4.004 4.004 4.004-4.004-4.004-4.004z"/>
                </svg>
              )}
              <span class="text-sm transition-colors duration-300">{link.name}</span>
            </a>
          ))}
        </div>
      </div>
    </section>
    
    <!-- Separator -->
    <div class="max-w-5xl mx-auto px-6 mb-16">
      <div class="h-px bg-white/10"></div>
    </div>
    
    <!-- About -->
    {description && (
      <section class="px-6 mb-16">
        <div class="max-w-3xl mx-auto">
          <h2 class="text-xs text-muted uppercase tracking-wider mb-8">About</h2>
          <div class="text-text/80 leading-relaxed space-y-6 text-lg">
            {description.split('\n\n').map(paragraph => (
              <p>{paragraph}</p>
            ))}
          </div>
        </div>
      </section>
    )}
    
    <!-- Tracklist -->
    {tracklist.length > 0 && (
      <section class="px-6 mb-16">
        <div class="max-w-3xl mx-auto">
          <h2 class="text-xs text-muted uppercase tracking-wider mb-4">Tracklist</h2>
          <div class="grid grid-cols-2 gap-x-8 gap-y-0.5">
            {tracklist.map((track) => (
              <div class="text-sm text-white/70">
                {String(track.number).padStart(2, '0')}. {track.title} <span class="text-white/30">({track.duration})</span>
              </div>
            ))}
          </div>
          
          <div class="mt-3 text-right">
            <span class="text-xs text-white/30">
              {(() => {
                const totalSeconds = tracklist.reduce((acc, t) => {
                  const [min, sec] = t.duration.split(':').map(Number);
                  return acc + min * 60 + sec;
                }, 0);
                const mins = Math.floor(totalSeconds / 60);
                const secs = totalSeconds % 60;
                return `${mins}:${String(secs).padStart(2, '0')}`;
              })()}
            </span>
          </div>
        </div>
      </section>
    )}
    
    <!-- Credits -->
    {credits.length > 0 && (
      <section class="px-6 mb-16">
        <div class="max-w-3xl mx-auto">
          <div class="credits-block py-8 border-y border-white/10">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-y-4 gap-x-8">
              {credits.map(credit => (
                <div class="credit-item">
                  <div class="text-[10px] text-white/30 uppercase tracking-wider mb-0.5">
                    {credit.role}
                  </div>
                  <div class="text-sm text-white/70">
                    {credit.name}
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </section>
    )}
    
    <!-- Player -->
    {release.soundcloudUrl && (
      <section class="px-6 mb-16">
        <div class="max-w-3xl mx-auto">
          <h2 class="text-xs text-muted uppercase tracking-wider mb-6">Player</h2>
          <div class="soundcloud-embed">
            <iframe 
              width="100%" 
              height="166" 
              scrolling="no" 
              frameborder="no" 
              allow="autoplay"
              src={`https://w.soundcloud.com/player/?url=${encodeURIComponent(release.soundcloudUrl)}&color=%23888888&auto_play=false&hide_related=true&show_comments=false&show_user=true&show_reposts=false&show_teaser=false&visual=false`}
            ></iframe>
          </div>
        </div>
      </section>
    )}
    
  </main>
</Layout>

<style>
  .soundcloud-embed {
    border-radius: 4px;
    overflow: hidden;
    background: rgba(255,255,255,0.02);
  }
  
  .soundcloud-embed iframe {
    display: block;
  }
  
  .streaming-b .icon-muted {
    opacity: 0.5;
  }
  
  .streaming-b[data-platform="soundcloud"] .icon-muted { color: rgb(251 146 60 / 0.5); }
  .streaming-b[data-platform="yandex"] .icon-muted { color: rgb(250 204 21 / 0.5); }
  .streaming-b[data-platform="spotify"] .icon-muted { color: rgb(74 222 128 / 0.5); }
  .streaming-b[data-platform="apple"] .icon-muted { color: rgb(248 113 113 / 0.5); }
  .streaming-b[data-platform="youtube"] .icon-muted { color: rgb(239 68 68 / 0.5); }
  .streaming-b[data-platform="deezer"] .icon-muted { color: rgb(251 191 36 / 0.5); }
  .streaming-b[data-platform="tidal"] .icon-muted { color: rgb(34 211 238 / 0.5); }
  
  .streaming-b:hover .icon-muted { opacity: 1; }
  .streaming-b[data-platform="soundcloud"]:hover .icon-muted { color: #FF5500; }
  .streaming-b[data-platform="yandex"]:hover .icon-muted { color: #FFCC00; }
  .streaming-b[data-platform="spotify"]:hover .icon-muted { color: #1ED760; }
  .streaming-b[data-platform="apple"]:hover .icon-muted { color: #FC3C44; }
  .streaming-b[data-platform="youtube"]:hover .icon-muted { color: #FF0000; }
  .streaming-b[data-platform="deezer"]:hover .icon-muted { color: #FEAA2D; }
  .streaming-b[data-platform="tidal"]:hover .icon-muted { color: #00FFFF; }
  
  .streaming-b:hover {
    border-color: rgba(255,255,255,0.25);
  }
  .streaming-b:hover span {
    color: white;
  }
  
  .credits-block {
    background: linear-gradient(to right, rgba(255,255,255,0.01), transparent, rgba(255,255,255,0.01));
  }
  
  .credit-item {
    min-width: 0;
  }
</style>
