---
import Layout from '../../../layouts/Layout.astro';
import Header from '../../../components/Header.astro';
import { getProjectBySlug, getProjects, urlFor } from '../../../lib/sanity';
import { PortableText } from 'astro-portabletext';

export async function getStaticPaths() {
  const projects = await getProjects();
  return projects
    .filter(p => p.hasPage)
    .map(project => ({
      params: { slug: project.slug.current },
    }));
}

const { slug } = Astro.params;
const lang = 'en';

const project = await getProjectBySlug(slug);

if (!project) {
  return Astro.redirect('/en/projects');
}

const title = project.title?.[lang] || project.title?.en || project.title?.ru || 'Project';
const subtitle = project.subtitle?.[lang] || project.subtitle?.en || project.subtitle?.ru || '';
const description = project.fullDescription?.[lang] || project.fullDescription?.en || project.fullDescription?.ru || [];

const heroImageUrl = project.heroImage 
  ? urlFor(project.heroImage).width(1920).url() 
  : project.image 
    ? urlFor(project.image).width(1920).url() 
    : '/og-image.png';

const gallery = project.gallery?.map(item => ({
  src: urlFor(item.asset).width(800).url(),
  fullSrc: urlFor(item.asset).width(1920).url(),
  caption: item.caption || '',
})) || [];

const videos = project.videos || [];
const socials = project.socials || [];
---

<Layout title={`${title} — Nomusicians`} lang={lang}>
  <Header currentLang={lang} />
  
  <main class="pt-20">
    <section class="relative h-[70vh] min-h-[500px] overflow-hidden">
      <div class="absolute inset-0 parallax-container">
        <img src={heroImageUrl} alt={title} class="w-full h-[120%] object-contain parallax-bg" style="transform: translateY(0)"/>
        <div class="absolute inset-0 bg-gradient-to-t from-background via-background/30 to-transparent"></div>
      </div>
      
      <div class="relative z-10 flex items-end h-full pb-12 px-6">
        <div class="max-w-4xl mx-auto w-full">
          <a href="/en/projects" class="inline-flex items-center gap-2 text-sm text-white/60 hover:text-white mb-4 transition-colors no-underline">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16l-4-4m0 0l4-4m-4 4h18"></path>
            </svg>
            Projects
          </a>
          <h1 class="text-4xl md:text-6xl font-light tracking-wide text-white mb-4" style="font-family: var(--font-logo);">{title}</h1>
          {subtitle && <p class="text-xl text-white/70 mb-2">{subtitle}</p>}
          <div class="flex items-center gap-4 flex-wrap">
            <p class="text-sm text-white/50 tracking-wider uppercase">{project.year}</p>
            {socials.length > 0 && (
              <div class="flex gap-3 items-center">
                {socials.map(link => {
                  const autoUrl = !link.url && link.label ? (
                    link.type === 'instagram' ? `https://instagram.com/${link.label.replace('@', '')}` :
                    link.type === 'telegram' ? `https://t.me/${link.label.replace('@', '')}` : null
                  ) : link.url;
                  return link.type === 'instagram' ? (
                    <a href={autoUrl} target="_blank" rel="noopener noreferrer" class="ig-icon-link text-white/40 hover:text-white transition-colors no-underline" aria-label="Instagram"><span class="ig-icon">IG</span></a>
                  ) : autoUrl ? (
                    <a href={autoUrl} target="_blank" rel="noopener noreferrer" class="text-sm text-white/40 hover:text-white transition-colors no-underline">{link.type === 'telegram' ? '✈' : '◎'} {link.label}</a>
                  ) : (
                    <span class="text-sm text-white/40">◎ {link.label}</span>
                  );
                })}
              </div>
            )}
          </div>
        </div>
      </div>
    </section>

    {description && description.length > 0 && (
      <section class="py-16 px-6">
        <div class="max-w-3xl mx-auto">
          <h2 class="text-2xl font-light tracking-wide text-center mb-8">Concept</h2>
          <div class="text-lg leading-relaxed text-text/80 space-y-6 portable-text">
            <PortableText value={description} />
          </div>
        </div>
      </section>
    )}

    {project.participants && project.participants.length > 0 && (
      <section class="py-16 px-6 bg-surface/30">
        <div class="max-w-4xl mx-auto">
          <h2 class="text-2xl font-light tracking-wide text-center mb-12">Credits</h2>
          <div class="grid md:grid-cols-3 gap-8 text-center">
            {project.participants.map(group => (
              <div>
                <h3 class="text-sm text-muted uppercase tracking-wider mb-4">{group.role}</h3>
                <div class="space-y-2">
                  {group.people?.map(person => (
                    <a href={`/en/people#${person.slug?.current || person._id}`} class="block text-white hover:text-white/70 transition-colors no-underline">{person.name}</a>
                  ))}
                  {group.andOthers && <span class="block text-white/50 italic">and others</span>}
                </div>
              </div>
            ))}
          </div>
        </div>
      </section>
    )}

    {videos.length > 0 && (
      <section class="py-16 px-6">
        <div class="max-w-5xl mx-auto">
          <h2 class="text-2xl font-light tracking-wide text-center mb-12">Video</h2>
          <div class:list={["grid gap-8", videos.length === 1 ? "md:grid-cols-1 max-w-2xl mx-auto" : "md:grid-cols-2"]}>
            {videos.map(video => (
              <div class="group">
                <div class="aspect-video bg-surface overflow-hidden relative">
                  <div class="absolute inset-0 z-10 bg-background/30 group-hover:bg-transparent transition-all duration-500 pointer-events-none"></div>
                  {video.youtubeUrl ? (
                    <iframe src={video.youtubeUrl.replace('watch?v=', 'embed/')} class="w-full h-full grayscale group-hover:grayscale-0 transition-all duration-500" frameborder="0" allowfullscreen></iframe>
                  ) : null}
                </div>
                <p class="text-sm text-muted mt-3 text-center">{video.title}</p>
              </div>
            ))}
          </div>
        </div>
      </section>
    )}

    {gallery.length > 0 && (
      <section class="py-16 bg-surface/30">
        <div class="max-w-6xl mx-auto px-6 mb-8">
          <h2 class="text-2xl font-light tracking-wide text-center mb-2">Gallery</h2>
          <p class="text-muted text-center text-sm">Swipe to browse →</p>
        </div>
        
        <div class="gallery-scroll overflow-x-auto scrollbar-hide">
          <div class="flex gap-4 px-6 md:px-12 w-max">
            {gallery.map((photo, index) => (
              <div class="flex-shrink-0 w-72 md:w-96 aspect-square overflow-hidden group cursor-pointer" data-lightbox-trigger data-index={index}>
                <img src={photo.src} alt={photo.caption} class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-500 group-hover:scale-105" loading="lazy"/>
              </div>
            ))}
          </div>
        </div>
      </section>
    )}

    {project.presentationUrl && (
      <section class="py-16 px-6 bg-surface/30">
        <div class="max-w-2xl mx-auto text-center">
          <h2 class="text-2xl font-light tracking-wide mb-6">Project Presentation</h2>
          <a href={project.presentationUrl} target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-3 px-8 py-4 border border-white/30 text-white hover:bg-white hover:text-black transition-all duration-300 group no-underline">
            <span class="text-sm tracking-wider uppercase">Open Presentation</span>
          </a>
        </div>
      </section>
    )}

    <section class="py-16 px-6 text-center">
      <a href="/en/projects" class="inline-flex items-center gap-2 text-white/60 hover:text-white transition-colors no-underline">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16l-4-4m0 0l4-4m-4 4h18"></path>
        </svg>
        All Projects
      </a>
    </section>

    <footer class="py-8 px-6 text-center text-muted text-sm border-t border-white/10">
      <p>© 2025 Nomusicians</p>
    </footer>
    
    <script type="application/json" id="gallery-data" set:html={JSON.stringify(gallery.map(g => ({src: g.fullSrc, caption: g.caption})))}></script>
  </main>
</Layout>

<style>
  .scrollbar-hide::-webkit-scrollbar { display: none; }
  .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
  .parallax-container { position: relative; overflow: hidden; }
  .parallax-bg { will-change: transform; transition: transform 0.1s ease-out; }
  .portable-text :global(p) { margin-bottom: 1.5rem; }
  .portable-text :global(strong) { color: white; }
  .ig-icon { display: inline-flex; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: 600; padding: 0.15rem 0.35rem; border: 1.5px solid currentColor; border-radius: 4px; letter-spacing: 0.05em; transition: all 0.2s ease; }
  .ig-icon-link:hover .ig-icon { background: white; color: black; border-color: white; }
</style>

<script>
  const photos = JSON.parse(document.getElementById('gallery-data')?.textContent || '[]');
  // Simplified lightbox - same as RU version
</script>

