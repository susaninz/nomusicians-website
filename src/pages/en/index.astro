---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Hero from '../../components/Hero.astro';
import Footer from '../../components/Footer.astro';
import { getEventsForHome, getVideoForHome, urlFor, type SanityEvent } from '../../lib/sanity';

const lang = 'en';

// Получаем события для главной из Sanity
const sanityEvents = await getEventsForHome();

// Функция форматирования даты
function formatDate(dateStr: string, lang: string): string {
  const date = new Date(dateStr);
  const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  const day = date.getDate();
  const month = months[date.getMonth()];
  const year = date.getFullYear();
  
  // Для текущего года не показываем год
  const currentYear = new Date().getFullYear();
  if (year === currentYear) {
    return `${month} ${day}`;
  }
  return `${month} ${day}, ${year}`;
}

// Преобразуем события в формат для отображения
const events = sanityEvents.map((e: SanityEvent) => {
  const city = e.city?.[lang] || e.city?.en || e.city?.ru || '';
  const venue = e.venue?.[lang] || e.venue?.en || e.venue?.ru || '';
  const description = e.description?.[lang] || e.description?.en || e.description?.ru || '';
  
  // Для концертов формируем место (Площадка, Город)
  const location = (e.eventType === 'concert' && (venue || city)) 
    ? [venue, city].filter(Boolean).join(', ') 
    : '';
  
  return {
    type: e.eventType,
    title: e.title?.[lang] || e.title?.en || e.title?.ru || '',
    location,
    description,
    date: formatDate(e.date, lang),
    time: e.time || null,
    buttonText: e.buttonText?.[lang] || e.buttonText?.en || e.buttonText?.ru || 'Details',
    buttonUrl: e.url || '#',
    isFuture: e.isFuture,
  };
});

// Получаем видео для главной (с галочкой showOnHome)
const homeVideo = await getVideoForHome();

// Функция для получения YouTube thumbnail
function getYoutubeThumbnail(url: string): string {
  const match = url?.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&]+)/);
  if (match && match[1]) {
    return `https://img.youtube.com/vi/${match[1]}/maxresdefault.jpg`;
  }
  return '/og-image.png';
}

const featuredVideo = homeVideo ? {
  title: homeVideo.titleEn || homeVideo.title,
  url: homeVideo.youtubeUrl,
  thumbnail: homeVideo.thumbnail 
    ? urlFor(homeVideo.thumbnail).width(800).url() 
    : getYoutubeThumbnail(homeVideo.youtubeUrl),
} : null;
---

<Layout title="Nomusicians — Electronics and neoclassics" lang="en">
  <Header currentLang={lang} />
  <main>
    <Hero lang={lang} />
    
    <!-- Featured Events Block -->
    {events.length > 0 && (
      <section class="bg-surface py-16 px-6">
        <div class="max-w-4xl mx-auto">
          <p class="text-muted text-sm tracking-[0.2em] uppercase mb-8 text-center">
            Featured
          </p>
          
          <!-- Event Cards -->
          <div class="grid gap-4">
            {events.map((event) => (
              <a 
                href={event.buttonUrl}
                class={`group flex items-center justify-between py-4 px-6 border ${event.isFuture ? 'border-white/20' : 'border-white/10'} hover:border-white/30 hover:bg-white/5 transition-all no-underline ${!event.isFuture ? 'opacity-60 hover:opacity-100' : ''}`}
              >
                <!-- Left: content -->
                <div class="text-left flex-1 min-w-0 pr-4">
                  <p class="text-white font-light flex items-center gap-2">
                    <span>
                      {event.title}
                      {event.location && <span class="text-white/50"> | {event.location}</span>}
                    </span>
                    {event.isFuture && (
                      <svg class="w-5 h-5 text-white flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
                      </svg>
                    )}
                  </p>
                  {event.description && <p class="text-muted text-sm text-justify">{event.description}</p>}
                </div>
                
                <!-- Right: date + button -->
                <div class="flex items-center gap-4 flex-shrink-0 min-w-[260px] justify-end">
                  <div class="text-right">
                    <p class="text-white text-sm">{event.date}</p>
                    {event.time && <p class="text-muted text-xs">{event.time}</p>}
                  </div>
                  <span class="px-3 py-1.5 border border-white/30 text-white text-xs tracking-wider uppercase whitespace-nowrap group-hover:bg-white group-hover:text-black transition-all">
                    {event.buttonText} →
                  </span>
                </div>
              </a>
            ))}
          </div>
          
          <!-- All Events -->
          <div class="mt-10 text-center">
            <a href="/en/events" class="text-muted hover:text-white transition-colors text-sm inline-flex items-center gap-2">
              All events
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
              </svg>
            </a>
          </div>
        </div>
      </section>
    )}

    <!-- Featured Video -->
    {featuredVideo && (
      <section id="watch" class="py-20 px-6">
        <div class="max-w-4xl mx-auto">
          <a 
            href={featuredVideo.url} 
            target="_blank" 
            rel="noopener noreferrer"
            class="block relative aspect-video group overflow-hidden no-underline"
          >
            <img 
              src={featuredVideo.thumbnail}
              alt={featuredVideo.title}
              class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-700"
            />
            <div class="absolute inset-0 bg-black/40 group-hover:bg-black/20 transition-all duration-500 flex items-center justify-center">
              <div class="w-20 h-20 rounded-full border-2 border-white/80 flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                <svg class="w-8 h-8 text-white ml-1" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M8 5v14l11-7z"/>
                </svg>
              </div>
            </div>
            <div class="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-black/80 to-transparent">
              <h3 class="text-white text-xl font-light">{featuredVideo.title}</h3>
            </div>
          </a>
        </div>
      </section>
    )}
    
    <Footer />
  </main>
</Layout>

<style>
  a {
    text-decoration: none !important;
  }
</style>
