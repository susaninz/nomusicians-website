---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import { getReleases, urlFor } from '../lib/sanity';
import { t } from '../i18n/translations';

const lang = 'ru';

// Получаем релизы из Sanity
const allReleases = await getReleases();

// Хелпер для создания slug
function slugify(text: string): string {
  return text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
}

// Группируем по категориям
const releases = {
  live: allReleases.filter(r => r.category === 'live').map(r => ({
    title: r.title,
    year: r.year,
    cover: r.cover ? urlFor(r.cover).width(400).url() : '/og-image.png',
    slug: slugify(r.title),
    artist: r.artist,
  })),
  studio: allReleases.filter(r => r.category === 'studio').map(r => ({
    title: r.title,
    year: r.year,
    cover: r.cover ? urlFor(r.cover).width(400).url() : '/og-image.png',
    slug: slugify(r.title),
  })),
  collabs: allReleases.filter(r => r.category === 'collabs').map(r => ({
    title: r.title,
    year: r.year,
    cover: r.cover ? urlFor(r.cover).width(400).url() : '/og-image.png',
    slug: slugify(r.title),
    artist: r.artist,
  })),
};
---

<Layout title="Релизы — Nomusicians" lang={lang}>
  <Header currentLang={lang} />
  
  <main class="pt-24 pb-16">
    <!-- Hero -->
    <section class="px-6 mb-16">
      <div class="max-w-4xl mx-auto text-center">
        <h1 class="text-4xl md:text-6xl font-light tracking-wide mb-6" style="font-family: var(--font-logo);">
          {t(lang, 'releases.title')}
        </h1>
        <p class="text-lg text-muted max-w-2xl mx-auto">
          Live записи, студийные работы и коллаборации
        </p>
      </div>
    </section>

    <!-- Live -->
    {releases.live.length > 0 && (
      <section class="px-6 mb-20">
        <div class="max-w-6xl mx-auto">
          <h2 class="text-2xl font-light tracking-wide mb-8 text-center">{t(lang, 'releases.live')}</h2>
          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            {releases.live.map((release) => (
              <a 
                href={`/releases/${release.slug}/`}
                class="group block no-underline"
              >
                <div class="aspect-square mb-3 overflow-hidden bg-surface">
                  <img 
                    src={release.cover} 
                    alt={release.title}
                    class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-500"
                  />
                </div>
                <h3 class="text-white font-light group-hover:text-muted transition-colors">{release.title}</h3>
                <p class="text-muted text-sm">{release.year}</p>
              </a>
            ))}
          </div>
        </div>
      </section>
    )}

    <!-- Studio -->
    {releases.studio.length > 0 && (
      <section class="px-6 mb-20">
        <div class="max-w-6xl mx-auto">
          <h2 class="text-2xl font-light tracking-wide mb-8 text-center">{t(lang, 'releases.studio')}</h2>
          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            {releases.studio.map((release) => (
              <a 
                href={`/releases/${release.slug}/`}
                class="group block no-underline"
              >
                <div class="aspect-square mb-3 overflow-hidden bg-surface">
                  <img 
                    src={release.cover} 
                    alt={release.title}
                    class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-500"
                  />
                </div>
                <h3 class="text-white font-light group-hover:text-muted transition-colors">{release.title}</h3>
                <p class="text-muted text-sm">{release.year}</p>
              </a>
            ))}
          </div>
        </div>
      </section>
    )}

    <!-- Collabs -->
    {releases.collabs.length > 0 && (
      <section class="px-6 mb-20">
        <div class="max-w-6xl mx-auto">
          <h2 class="text-2xl font-light tracking-wide mb-8 text-center">{t(lang, 'releases.collabs')}</h2>
          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            {releases.collabs.map((release) => (
              <a 
                href={`/releases/${release.slug}/`}
                class="group block no-underline"
              >
                <div class="aspect-square mb-3 overflow-hidden bg-surface">
                  <img 
                    src={release.cover} 
                    alt={release.title}
                    class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-500"
                  />
                </div>
                <h3 class="text-white font-light group-hover:text-muted transition-colors">{release.title}</h3>
                {release.artist && <p class="text-muted text-sm">{release.artist}</p>}
                <p class="text-muted text-sm">{release.year}</p>
              </a>
            ))}
          </div>
        </div>
      </section>
    )}
  </main>
</Layout>

<style>
  a {
    text-decoration: none !important;
  }
  a:visited {
    color: inherit;
  }
</style>
